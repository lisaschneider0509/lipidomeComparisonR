---
title: "Lipidome Comparison Progress Report"
author: "Lisa Schneider"
date: "June 14, 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Dependencies
The files with the self-written functions for this workflow are loaded with source(). The first source-file "install_packages_lipidome_comparison.R" contains a function that installs all required packages. The installed packages are loaded into the namespace with library().

```{r dependencies}
## installation script for all used packages
source("install_packages_lipidome_comparison.R")
# install_packages_lipidome_comparison() # installs all reqired packages for this workflow 

library(dplyr) # select part of data
library(stringr) # count separators
library(data.table) # transpose data frame
library(impute)
library(imputeLCMD) # left censored data imputation

library(ggplot2)#, # plots
library(tibble) # data frame manipulation
library(viridis) # colorblind save color schemes
library(GGally) # paralell plot
library(fmsb) # spider chart
library(scales) # scale opacity of filling (alpha)
library(ggpubr) # multiple plots on one page

library(ggrepel)
library(factoextra)
library(ggfortify) # biplot with ggplot
library(corrplot)
library(FactoMineR)

library(heatmaply) # interactive heatmap
library(gplots) # heatmap
library(plotly) # interactive ggplots
library(htmlwidgets) # save plotly-plots as html
library(dendextend)

source("lipidome_comparison_dataTransformaions.R")
source("lipidome_comparison_EDA.R")
source("lipidome_comparison_pca.R")
source("lipidome_comparison_clustering.R")
source("lipidome_comparison_hypothesis_testing.R")

```

## Setting themes and path 
The theme_set() command males all plots look similar. 
Path settings depend on the respective operating system. 

```{r theme_and_path}
# set ggplot theme
my_theme <- theme_set(
  theme_minimal() +
    theme(plot.title = element_text(size=12, hjust = 0.5, family="AvantGarde"),
          plot.subtitle = element_text(size = 8, hjust = 0.5, family = "AvantGarde", colour = "grey40"),
          axis.text.x = element_text(size = 8, colour = "grey40", family="AvantGarde"),
          axis.text.y = element_text(size = 8, colour = "grey40", family="AvantGarde"),
          axis.title.x = element_text(size = 10, hjust = 0.5, colour = "grey40", family="AvantGarde"),
          axis.title.y = element_text(size = 10, hjust = 0.5, colour = "grey40", family="AvantGarde"),
          legend.text = element_text(size = 8, colour = "grey40", family="AvantGarde"),
          legend.title = element_text(size = 10, colour = "grey40", family="AvantGarde"))
)

## set variables
getwd()
working_directory <- getwd()

test_path <- paste(working_directory, "/data/Probe-Datensatz_lisa.csv", sep = "")
meat_data_path <- paste(working_directory, "/data/meat_fish_final_raw.csv", sep = "")
meat_annotation_path <- paste(working_directory, "/data/meat_annotation.csv", sep = "")

plot_path <- paste(working_directory, "/plots", sep = "")
plot_name <- paste(plot_path, "/meat_data", sep = "")
```

## Making a sample matrix

```{r data_matrix}
meat_data <- read.csv(meat_data_path, sep = ",", dec = ".", header = TRUE)
meat_data <- subset(meat_data, select = c(Compound, Type, Filename, Status, Group, Area))
meat_data <- subset(meat_data, Status == "Processed")
# meat_data[meat_data==''] <- NA
meat_data[meat_data=='N/F'] <- NA
meat_data$Area <- as.numeric(as.character(meat_data$Area))
meat_target <- subset(meat_data, Type == "Target Compound")
meat_standard <- subset(meat_data, Type == "Internal Standard")

meat_target <- flip_df(meat_target)
meat_standard <- flip_df(meat_standard)

meat_target$SID <- sub(".*probe","sample", meat_target$SID)
meat_target$SID <- sub("\\.*pos2","2", meat_target$SID)
meat_target$SID <- sub("\\.*pos","1", meat_target$SID)

meat_target <- subset(meat_target, str_detect(meat_target$SID, "sample") == TRUE)

meat_AS <- meat_target$SID[str_detect(meat_target$SID, "AS") == TRUE]
meat_target$SID[str_detect(meat_target$SID, "AS") == TRUE] <- sub(".*sample","AS_sample", meat_AS)
meat_N <- meat_target$SID[str_detect(meat_target$SID, "AS") == FALSE]
meat_target$SID[str_detect(meat_target$SID, "AS") == FALSE] <- sub(".*sample","N_sample", meat_N)
meat_target$SID <- str_remove(meat_target$SID, "_AS")

meat_annotation <- read.csv(meat_annotation_path)

meta_info <- read.table(text = meat_target$SID, sep = "_")
colnames(meta_info) <- c("Treatment", "Sample_nr", "Independent_rep", "Tech_rep")
meta_info$Independent_rep <- paste(meta_info$Sample_nr, meta_info$Independent_rep, sep = "_")
meta_info$Tech_rep <- paste(meta_info$Independent_rep, meta_info$Tech_rep, sep = "_")

meat_target <- cbind(meat_target$SID, meta_info, meat_target[, -1])
meat_target <- droplevels(meat_target)

meat_target <- subset(meat_target, select = colnames(meat_target) != "Group")

map <- data.frame(Sample_nr=meat_annotation$Sample, 
                  Meat_type=meat_annotation$Meat.type
                  # Meat_species = meat_annotation$Meat.species
                  )
meat_data <- left_join(meat_target[1:3], map, by="Sample_nr")
meat_target <- subset(cbind(meat_data, meat_target), select=which(!duplicated(names(cbind(meat_data, meat_target))))) 
DT::datatable(meat_target)
```

## Data transformation
```{r data_transformation}
### log2 
log_meat <- log2(select_if(meat_target, is.numeric))
log_meat <- cbind(select_if(meat_target, is.character), select_if(meat_target, is.factor), log_meat)
meat_data <- log_meat

### impute missing values 
#### remove columns where all values are missing
impute_meat <- meat_data[, which(colMeans(!is.na(meat_data)) > 0.8)] 
impute_meat <- as.matrix(select_if(impute_meat, is.numeric))

#### perform missing data imputation
meat_imputed <- as.data.frame(impute.QRILC(impute_meat, tune.sigma = 1)[[1]])
# meat_imputed <- as.data.frame(impute.MinDet(impute_meat))
meat_imputed <- cbind(meat_data[, 1:6], meat_imputed)
meat_imputed <- droplevels(meat_imputed) # remove unused levels from factors

#### calculate the means for the replicates
meat_groups <- generate_categorical_table(meat_imputed$Meat_type)

meat_numeric <- meat_imputed
meat_numeric$Sample_nr <- as.numeric(meat_numeric$Sample_nr)
meat_numeric$Group <- as.numeric(meat_numeric$Meat_type)
# meat_by_sample <- calc_by_replicate(meat_numeric, meat_numeric$Sample_nr, mean)
meat_by_replicate <- calc_by_replicate(meat_numeric, meat_numeric$Independent_rep, mean)

meat_data <- paste_catecorical_variable(meat_by_replicate, ncol(meat_by_replicate), meat_groups)
colnames(meat_data)[1] <- "Independent_rep"
meat_data$Sample_nr <- paste("sample", meat_data$Sample_nr, sep = "")
```

## Exploratory data analysis
```{r eda}
### graphical exploratory data analysis
qqplot_by_factor(meat_data, "Group", out_path = plot_name)
histogram_by_factor(meat_data, "Group", out_path = plot_name)
boxplot_by_factor(meat_data, "Group", out_path = plot_name)
# 
# parallel_plot(meat_data, meat_data$Group, out_path = plot_name)
# meat_spider <- calc_by_replicate(meat_data, meat_data$Group, mean)
# spider_chart(meat_spider, legend_lab = meat_spider$Group.1, out_path = plot_name)

### test for normality
meat_normality <- shapiro_by_factor(meat_data, meat_data$Group)
```

```{r correlation}
### test for correlation
meat_correlation <- cor(select_if(meat_data, is.numeric), method = "pearson")
cor_heatmap <- matrix_heatmap(meat_correlation, title = "Correlation heatmap", interactive = TRUE)
ggsave(paste(plot_name, "correlation.png", sep = "_"), plot = cor_heatmap, width = 10, height = 7, device = "png")

```

```{r ratios}
### lipid ratios
meat_sample_means <- calc_by_replicate(meat_data, factor = meat_data$Sample_nr, mean)
meat_group_means <- calc_by_replicate(meat_data, factor = meat_data$Group, mean)

## ratio heatmap
{
# ratio matrix
ratio_list <- lapply(1:nrow(meat_group_means), 
                       function(i) calculate_ratio_matrix(as.numeric(meat_group_means[i, -1]),
                                                          names_vector = colnames(meat_group_means)[-1]))
names(ratio_list) <- as.character(meat_group_means$Group.1)


# save ratio matrixes to csv
lapply(1:length(ratio_list), 
       function(i) write.csv(ratio_list[[i]], 
                             file = paste("output/ratio_matrix_", 
                                          names(ratio_list[i]), ".csv", 
                                          sep = ""),
                             row.names = TRUE))
# ratio heatmap
heatmap_list <- lapply(1:length(ratio_list), 
       function(i) matrix_heatmap(ratio_list[[i]], 
                                  title = names(ratio_list)[i]))
names(heatmap_list) <- names(ratio_list)

# ratio heatmap html
# lapply(1:length(heatmap_list), 
#        function(i) saveWidget(heatmap_list[[i]], 
#                               file = paste(plot_path, 
#                                            "/ratio_heatmap_", 
#                                            names(heatmap_list)[i], 
#                                            ".html", sep = "")))
# ratio heatmaps arranged
arranged_ratio_heatmaps <- ggarrange(plotlist = heatmap_list, 
          ncol = 3, 
          nrow = 1, 
          align = "h", 
          common.legend = TRUE, 
          legend = "right")
arranged_ratio_heatmaps <- annotate_figure(arranged_ratio_heatmaps, 
                                top = text_grob("Lipid ratios", 
                                                size = 20, family = "AvantGarde"))

# save ratio heatmaps
ggsave(filename = paste(plot_name, "ratio_heatmap.png", sep = "_"), 
       plot = arranged_ratio_heatmaps, width = 36, height = 12, device = "png")
}

# ratio barplots
ratio_lipids <- colnames(meat_group_means[str_detect(colnames(meat_group_means), "40:6") |
                                            str_detect(colnames(meat_group_means), "36:0")])

barchart_list <- plot_ratio_barcharts(meat_group_means, ratio_lipids, group_column = "Group.1")
arranged_barcharts <- ggarrange(plotlist = barchart_list,
                                align = "h", 
                                ncol = 6, 
                                nrow = 6, 
                                # widths = c(0.9, 0.9),
                                # common.legend = TRUE, 
                                legend = "none")
ggsave(filename = paste(plot_name, "ratio_bar1.png", sep = "_"), 
       plot = arranged_barcharts[[1]], width = 24, height = 24, device = "png")
ggsave(filename = paste(plot_name, "ratio_bar2.png", sep = "_"), 
       plot = arranged_barcharts[[2]], width = 24, height = 24, device = "png")
ggsave(filename = paste(plot_name, "ratio_bar3.png", sep = "_"), 
       plot = arranged_barcharts[[3]], width = 24, height = 24, device = "png")
ggsave(filename = paste(plot_name, "ratio_bar.png", sep = "_"), 
       plot = arranged_barcharts, width = 24, height = 24, device = "png")
```

```{r univariate}
# meat vs fish volcano plot
meat_vs_fish <- subset(meat_data, Group == "fish" | Group == "beef")
meat_vs_fish <- droplevels(meat_vs_fish)

p_meat_vs_fish <- one_sample_test_by_col(meat_vs_fish, meat_vs_fish$Group, method = t.test)
adj_meat_vs_fish <- p.adjust(p_meat_vs_fish$p_values, method = "fdr")
fc_meat_vs_fish <- log2_foldchange(meat_vs_fish, 
                                   meat_vs_fish$Group, 
                                   control_group = "fish", 
                                   test_group = "beef")

meat_fish_volcano <- data.frame(p_value = p_meat_vs_fish, adj_p_value = adj_meat_vs_fish, log2_foldchange = fc_meat_vs_fish)

vp <- volcano_plot(meat_fish_volcano, 
             foldchange_col = meat_fish_volcano$log2_foldchange, 
             significance_col = meat_fish_volcano$adj_p_value, 
             foldchange = 2, 
             significance = 0.05, 
             # interactive = TRUE,
             title = "Volcano plot for fish vs. beef")

ggsave(paste(plot_name, "volcano.png", sep = "_"), 
       plot = vp, 
       width = 8, 
       height = 6,
       device = "png")
ggplotly(vp, tooltip = "rownames")
```

```{r pca}
### PCA
meat_pca <- PCA(select_if(meat_data, is.numeric), scale.unit = TRUE, graph = FALSE)
meat_eigenvalue <- get_eigenvalue(meat_pca)
fscree <- scree_factoextra(meat_pca)
ggsave(paste(plot_name, "fscree.png", sep = "_"), 
       plot = fscree, 
       width = 9, 
       height = 6,
       device = "png")

png(paste(plot_name, "bscree.png", sep = "_"), width = 800, height = 400)
scree_base(select_if(meat_data, is.numeric))
dev.off()

ggbi <- biplot_ggplot2(meat_data, "Group", loadings = FALSE, ellipse = TRUE, scale = TRUE)
ggsave(paste(plot_name, "ggbiplot.png", sep = "_"), 
       plot = ggbi, 
       width = 9, 
       height = 6,
       device = "png")

biplot_factoextra(meat_pca, meat_data$Group, ellipse = TRUE)


# loadings plots 
fviz_pca_var(meat_pca, # factoextra
             geom = c("point"), 
             col.var = "contrib", 
             gradient.cols = viridis(n = 3, direction = -1), 
             repel = TRUE)

ggloadings <- plot_loadings(meat_pca, colour = TRUE, top_loadings = 10) # diy wth ggplot
ggsave(paste(plot_name, "ggloadings.png", sep = "_"), 
       plot = ggloadings, 
       width = 6, 
       height = 6,
       device = "png")


# contribution to PCs
plot_contrib_to_pc(meat_pca)

pc1 <- fviz_contrib(meat_pca, choice = "var", axes = 1, top = 10, 
             fill = viridis(n = 1, begin = 0.3), color = viridis(n = 1, begin = 0.3), 
             ggtheme = my_theme)
ggsave(paste(plot_name, "pc1.png", sep = "_"), 
       plot = pc1, 
       width = 6, 
       height = 6,
       device = "png")

pc2 <- fviz_contrib(meat_pca, choice = "var", axes = 2, top = 10, 
             fill = viridis(n = 1, begin = 0.3), color = viridis(n = 1, begin = 0.3), 
             ggtheme = my_theme, 
             linecolor = "black")
ggsave(paste(plot_name, "pc2.png", sep = "_"), 
       plot = pc2, 
       width = 6, 
       height = 6,
       device = "png")


meat_var <- meat_pca$var
meat_contrib <- as.data.frame(meat_var$contrib)
pc1_contrib_table <- meat_contrib[order(meat_contrib$Dim.1, decreasing = TRUE),]
pc1_contrib <- rownames(pc1_contrib_table)[1:10]
pc2_contrib_table <- meat_contrib[order(meat_contrib$Dim.2, decreasing = TRUE),]
pc2_contrib <- rownames(pc2_contrib_table)[1:10]
meat_pca_sub <- subset(meat_data, select = c("Sample_nr", "Group", pc1_contrib, pc2_contrib))

pp <- parallel_plot(meat_pca_sub, meat_pca_sub$Group)
ggsave(paste(plot_name, "parallel.png", sep = "_"), 
       plot = pp, 
       width = 10, 
       height = 6,
       device = "png")
means_meat_pca <- calc_by_replicate(meat_pca_sub, meat_pca_sub$Group, funct = mean)

png(filename = paste(plot_name, "spider2.png", sep = "_"), 
    width = 600, 
    height = 600
    )
spider_chart(means_meat_pca, legend_lab = means_meat_pca$Group.1)
dev.off()


```

```{r clustering}
### Clustering 
meat_clust <- data.frame(Group = meat_data$Group, SID = meat_data$Sample_nr)
meat_clust <- cbind(meat_clust, select_if(meat_data, is.numeric))
rownames(meat_clust) <- meat_data$SID

hclust_performance_table(meat_clust)
hclust_performance <- hclust_performance_plot(meat_clust)
ggsave(paste(plot_name, "hclust_performance.png", sep = "_"), 
       plot = hclust_performance, 
       width = 6, 
       height = 6,
       device = "png")

meat_dist <- dist(select_if(meat_clust, is.numeric), method = "manhattan")
meat_hclust <- hclust(meat_dist, method = "average")

png(paste(plot_name, "hclust_dendrogram.png", sep = ""), width = 500, height = 500)
hclust_dendrogram(meat_hclust, 
                  labs = paste(meat_data$Sample_nr, 
                               meat_clust$Group, sep = "-"))
dev.off()

# hclust_heatmap(meat_clust,
#                dist_method = "manhattan",
#                hclust_method = "average",
#                row_names = meat_clust$Group)

hclust_heatmap_interactive(meat_clust[-2], 
                           dist_method = "manhattan", 
                           hclust_method = "average", row_names = meat_clust$SID)

```